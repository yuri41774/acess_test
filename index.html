<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste de Acessibilidade Interativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Content Security Policy: allows our static assets and CDN for axe/jspdf; tightens defaults for production -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self';">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axe-core/4.7.0/axe.min.js"></script>
  <!--
    Melhorias aplicadas v2:
    - Layout responsivo com grid e container centralizado
    - Marca√ß√£o sem√¢ntica (header, main, footer)
    - Link "pular para o conte√∫do" para acessibilidade por teclado
    - Melhores estilos para foco, contraste e tipografia
    - Mantidos IDs e fun√ß√µes JS existentes
    - Mensagem de feedback com classes de sucesso/erro
    Novas melhorias:
    - Modo escuro autom√°tico e manual
    - Visualiza√ß√£o de telas j√° adicionadas
    - Exporta√ß√£o CSV
    - Valida√ß√µes autom√°ticas com axe-core
    - Armazenamento local (localStorage)
    - Atalhos de teclado
  -->
  <style>
    /* Reset e vari√°veis */
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      /* Tema claro (padr√£o) */
      --bg: #ffffff;
      --text: #222831;
      --muted: #555b6e;
      --accent: #2c7be5;
      --surface: #f7f9fc;
      --success-bg: #d4edda;
      --error-bg: #f8d7da;
      --border: #d1d5db;
      --focus: rgba(44,123,229,0.18);
      --shadow: rgba(16,24,40,0.06);
    }
    
    /* Tema escuro */
    [data-theme="dark"] {
      --bg: #1a1b1e;
      --text: #e9ecef;
      --muted: #868e96;
      --accent: #4dabf7;
      --surface: #141517;
      --success-bg: #064e3b;
      --error-bg: #7f1d1d;
      --border: #2c2e33;
      --focus: rgba(77,171,247,0.2);
      --shadow: rgba(0,0,0,0.2);
    }
    
    /* Prefer√™ncia do sistema */
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg: #1a1b1e;
        --text: #e9ecef;
        --muted: #868e96;
        --accent: #4dabf7;
        --surface: #141517;
        --success-bg: #064e3b;
        --error-bg: #7f1d1d;
        --border: #2c2e33;
        --focus: rgba(77,171,247,0.2);
        --shadow: rgba(0,0,0,0.2);
      }
    }

    /* Base */
    html,body { height: 100%; }
    body {
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      margin: 0;
      background: var(--surface);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: 16px;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
      background: var(--bg);
      padding: 20px 24px;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(16,24,40,0.06);
    }
    header h1 { margin: 0 0 8px 0; font-size: 1.4rem; }
    h2 { color: #2c3e50; margin-top: 18px; }
    .intro { color: var(--muted); margin-bottom: 10px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      color: var(--text);
      resize: vertical;
      font-size: 0.95rem;
    }
    textarea { min-height: 84px; }
    .info { font-size: 0.9rem; color: var(--muted); margin-bottom: 6px; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 18px;
      align-items: start;
    }
    .full { grid-column: 1 / -1; }
    .actions { margin-top: 14px; display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      appearance: none;
      border: none;
      background: var(--accent);
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
    }
    button.secondary { background: #6c757d; }
    button:focus { outline: 3px solid rgba(44,123,229,0.18); }
    #feedbackMessage {
      font-size: 0.95rem;
      padding: 10px;
      margin-top: 12px;
      border-radius: 6px;
      display: none;
    }
  #feedbackMessage.sucesso { background: var(--success-bg); color: #155724; border: 1px solid #c3e6cb; }
  #feedbackMessage.erro { background: var(--error-bg); color: #721c24; border: 1px solid #f5c6cb; }
  /* estilo para mensagens informativas */
  #feedbackMessage.info { background: var(--surface); color: var(--muted); border: 1px solid var(--border); }
    /* Skip link */
    .skip-link {
      position: absolute;
      left: -999px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
    .skip-link:focus {
      left: 16px;
      top: 16px;
      width: auto;
      height: auto;
      padding: 8px 12px;
      background: #000;
      color: #fff;
      border-radius: 6px;
      z-index: 9999;
    }
    footer { margin-top: 20px; color: var(--muted); font-size: 0.9rem; }
    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
      .container { padding: 16px; }
    }
    @media (prefers-contrast: more) { 
      button { box-shadow: 0 0 0 3px #000 inset; }
      .info { color: #000; }
    }

    /* Novos componentes */
    .theme-toggle {
      position: fixed;
      top: 16px;
      right: 16px;
      padding: 8px;
      border-radius: 50%;
      background: var(--bg);
      border: 2px solid var(--border);
      color: var(--text);
      cursor: pointer;
      box-shadow: 0 2px 4px var(--shadow);
      transition: all 0.2s ease;
      z-index: 100;
    }
    .theme-toggle:hover { transform: scale(1.1); }
    
    .telas-lista {
      margin-top: 24px;
      border-top: 2px solid var(--border);
      padding-top: 24px;
    }
    .tela-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .tela-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .tela-titulo { margin: 0; font-size: 1.1rem; }
    .tela-acoes { display: flex; gap: 8px; }
    .tela-conteudo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
    }
    .tela-campo {
      background: var(--bg);
      padding: 12px;
      border-radius: 6px;
    }
    .tela-campo h4 { margin: 0 0 8px 0; font-size: 0.9rem; }
    .tela-campo p { margin: 0; color: var(--muted); font-size: 0.9rem; }
    
    .status-check {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85rem;
    }
    .status-check.ok { background: var(--success-bg); color: #10b981; }
    .status-check.warn { background: #fef3c7; color: #d97706; }
    .status-check.error { background: var(--error-bg); color: #ef4444; }

    .atalhos {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: var(--bg);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow);
      border: 1px solid var(--border);
      max-width: 300px;
      font-size: 0.9rem;
      display: none;
    }
    .atalhos.visible { display: block; }
    .atalhos kbd {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 0.85rem;
    }
    /* Estilos do modal de confirma√ß√£o */
    .confirm-overlay {
      position: fixed;
      inset: 0;
      display: none; /* escondido por padr√£o; respeita atributo [hidden] */
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.35);
      z-index: 2000;
    }
    .confirm-overlay:not([hidden]) {
      display: flex;
    }
    .confirm-modal {
      background: var(--bg);
      color: var(--text);
      padding: 16px;
      border-radius: 8px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
      border: 1px solid var(--border);
    }
    /* Tool selector */
    .tool-selector { background: var(--surface); border: 1px solid var(--border); padding: 16px; border-radius:8px; margin: 12px 0; }
    .tool-selector h2 { margin-top: 0; }
  </style>
</head>
<body>
  <button class="theme-toggle" aria-label="Alternar tema claro/escuro" onclick="toggleTheme()">
    <span id="themeIcon">üåû</span>
  </button>
  <button style="position:fixed;top:16px;left:16px;padding:8px;border-radius:8px;z-index:150;" onclick="openToolSelector()">Escolher ferramenta</button>

  <a class="skip-link" href="#mainContent">Pular para o conte√∫do</a>
  <div class="container">
    <header>
      <h1>üß™ Roteiro de Teste de Acessibilidade Interativo</h1>
      <p class="intro">Preencha os campos abaixo para registrar observa√ß√µes e gerar um relat√≥rio de acessibilidade.</p>
      
      <div class="status-check ok">
        <span>Valida√ß√£o autom√°tica em execu√ß√£o</span>
      </div>
    </header>

    <!-- Seletor inicial de ferramenta -->
    <section id="toolSelector" class="tool-selector" aria-label="Escolha da ferramenta">
      <h2>Escolha a ferramenta</h2>
      <p class="info">Selecione como voc√™ quer executar as checagens de acessibilidade.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
        <button type="button" onclick="chooseTool('in-app')">Ferramentas locais (no navegador)</button>
        <button type="button" onclick="chooseTool('remote')">Analisador remoto (Puppeteer + axe)</button>
        <button type="button" onclick="chooseTool('example')" class="secondary">Abrir exemplo de integra√ß√£o</button>
      </div>
      <p class="info" style="margin-top:12px;font-size:0.9rem">Voc√™ pode mudar a escolha depois usando o bot√£o "Escolher ferramenta" no topo.</p>
    </section>

    <main id="mainContent">
      <h2>üìã Informa√ß√µes da Tela</h2>

      <form id="formTela" onsubmit="event.preventDefault()">
        <div class="grid">
          <div class="full">
            <label for="nomeTela">Nome da Tela:</label>
            <input type="text" id="nomeTela" name="nomeTela" aria-describedby="nomeHelp">
            <div id="nomeHelp" class="info">Informe um nome curto e descritivo da tela.</div>
          </div>

          <div>
            <label for="leitorResultado">üîä Leitor de Tela:</label>
            <div class="info">Verifique se todos os elementos da interface s√£o lidos corretamente e em ordem l√≥gica por um leitor de tela.</div>
            <select id="leitorResultado" name="leitorResultado">
              <option value="Positivo">Positivo</option>
              <option value="Negativo">Negativo</option>
            </select>
            <label for="leitorObs" class="full">Observa√ß√µes</label>
            <textarea id="leitorObs" name="leitorObs" placeholder="Observa√ß√µes sobre o teste de leitor de tela"></textarea>
          </div>

          <div>
            <label for="contrasteResultado">üé® Contraste:</label>
            <div class="info">Verifique se o contraste entre texto e fundo atende aos padr√µes WCAG AA ou AAA.</div>
            <select id="contrasteResultado" name="contrasteResultado">
              <option value="Positivo">Positivo</option>
              <option value="Negativo">Negativo</option>
            </select>
            <label for="contrasteObs" class="full">Observa√ß√µes</label>
            <textarea id="contrasteObs" name="contrasteObs" placeholder="Observa√ß√µes sobre o teste de contraste"></textarea>
          </div>

          <div>
            <label for="ampliacaoResultado">üîç Amplia√ß√£o:</label>
            <div class="info">Verifique se a interface permanece funcional e leg√≠vel com zoom de at√© 200%.</div>
            <select id="ampliacaoResultado" name="ampliacaoResultado">
              <option value="Positivo">Positivo</option>
              <option value="Negativo">Negativo</option>
            </select>
            <label for="ampliacaoObs" class="full">Observa√ß√µes</label>
            <textarea id="ampliacaoObs" name="ampliacaoObs" placeholder="Observa√ß√µes sobre o teste de amplia√ß√£o"></textarea>
          </div>

          <div>
            <label for="tecladoResultado">‚å®Ô∏è Navega√ß√£o por Teclado:</label>
            <div class="info">Verifique se √© poss√≠vel navegar por todos os elementos da interface usando apenas o teclado.</div>
            <select id="tecladoResultado" name="tecladoResultado">
              <option value="Positivo">Positivo</option>
              <option value="Negativo">Negativo</option>
            </select>
            <label for="tecladoObs" class="full">Observa√ß√µes</label>
            <textarea id="tecladoObs" name="tecladoObs" placeholder="Observa√ß√µes sobre o teste de navega√ß√£o por teclado"></textarea>
          </div>

          <div>
            <label for="coresResultado">üåà Uso de Cores:</label>
            <div class="info">Verifique se as informa√ß√µes n√£o dependem exclusivamente de cores para serem compreendidas.</div>
            <select id="coresResultado" name="coresResultado">
              <option value="Positivo">Positivo</option>
              <option value="Negativo">Negativo</option>
            </select>
            <label for="coresObs" class="full">Observa√ß√µes</label>
            <textarea id="coresObs" name="coresObs" placeholder="Observa√ß√µes sobre o teste de uso de cores"></textarea>
          </div>

          <div>
            <label for="responsivoResultado">üì± Responsividade:</label>
            <div class="info">Verifique se a interface se adapta corretamente a diferentes tamanhos de tela e dispositivos.</div>
            <select id="responsivoResultado" name="responsivoResultado">
              <option value="Positivo">Positivo</option>
              <option value="Negativo">Negativo</option>
            </select>
            <label for="responsivoObs" class="full">Observa√ß√µes</label>
            <textarea id="responsivoObs" name="responsivoObs" placeholder="Observa√ß√µes sobre o teste de responsividade"></textarea>
          </div>
        </div>

        <div class="actions">
          <button type="button" onclick="adicionarTela()">Adicionar Tela ao Relat√≥rio</button>
          <button type="button" class="secondary" onclick="gerarPDF()">Gerar Relat√≥rio em PDF</button>
          <button type="reset" class="secondary">Limpar</button>
          <button type="button" class="secondary" onclick="runFullA11yChecks()">Executar checagens</button>
          <button type="button" class="secondary" onclick="exportLastAxeResults()">Exportar JSON</button>
        </div>
      </form>

      <div id="feedbackMessage" class="feedback" role="status" aria-live="polite"></div>

      <section class="telas-lista" id="telasLista" aria-label="Telas testadas">
        <h2>üìä Telas Testadas</h2>
        <div id="telasContainer">
          <!-- Telas ser√£o inseridas aqui dinamicamente -->
        </div>
      </section>

      <section id="a11yResults" aria-label="Resultados de acessibilidade" style="margin-top:18px;">
        <h2>üîé Resultados das Checagens</h2>
        <div id="a11yContainer">
          <p class="info">Nenhuma checagem executada ainda.</p>
        </div>
      </section>

      <section id="remoteChecker" aria-label="Analisador remoto" style="margin-top:18px;">
        <h2>üåê Analisador Remoto (opcional)</h2>
        <div class="info">Insira a URL de uma p√°gina (pode ser local, ex.: <code>http://127.0.0.1:8080/index.html</code>) e seletores opcionais para capturar screenshots. Requer o <code>remote-check-server</code> rodando em <code>http://localhost:3001</code>.</div>
        <label for="remoteUrl">URL da p√°gina</label>
        <input id="remoteUrl" type="text" placeholder="http://127.0.0.1:8080/index.html" />
        <label for="remoteSelectors">Seletores (opcional, separados por v√≠rgula)</label>
        <input id="remoteSelectors" type="text" placeholder="#mainContent,.header" />
        <div class="actions" style="margin-top:8px;">
          <button type="button" onclick="runRemoteCheckFromIndex()">Executar checagem remota</button>
          <button type="button" class="secondary" onclick="window.open('/examples/remote-check.html','_blank')">Abrir interface remota</button>
        </div>
        <h3>Resultado remoto</h3>
        <pre id="remoteOut" style="background:#0f1724;color:#e6eef8;padding:12px;border-radius:6px;max-height:320px;overflow:auto;">Nenhum resultado ainda.</pre>
      </section>
    </main>

    <footer>
      <p>Arquivo de teste de acessibilidade ‚Äî mantenha os campos claros e objetivos. <strong>Ative o leitor de tela</strong> e teste com zoom para valida√ß√£o.</p>
      <p>Pressione <kbd>?</kbd> para ver os atalhos de teclado dispon√≠veis.</p>
    </footer>
  </div>

  <div id="atalhos" class="atalhos" role="dialog" aria-label="Atalhos de teclado">
    <h3>Atalhos de Teclado</h3>
    <ul>
      <li><kbd>?</kbd> - Mostrar/ocultar atalhos</li>
      <li><kbd>Alt</kbd> + <kbd>A</kbd> - Adicionar tela</li>
      <li><kbd>Alt</kbd> + <kbd>P</kbd> - Gerar PDF</li>
      <li><kbd>Alt</kbd> + <kbd>C</kbd> - Exportar CSV</li>
      <li><kbd>Alt</kbd> + <kbd>T</kbd> - Alternar tema</li>
      <li><kbd>Alt</kbd> + <kbd>L</kbd> - Limpar formul√°rio</li>
    </ul>
  </div>

  <!-- Modal de confirma√ß√£o acess√≠vel -->
  <div id="confirmOverlay" class="confirm-overlay" hidden>
    <div id="confirmModal" class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">Confirma√ß√£o</h3>
      <p id="confirmMessage">Tem certeza?</p>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button id="confirmCancel" class="secondary" type="button">Cancelar</button>
        <button id="confirmOk" type="button">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    // Estado da aplica√ß√£o
    let telas = [];
    let validacaoAtiva = false;
    let lastAxeResults = null; // guarda √∫ltimo resultado do axe

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', () => {
  // Carregar tema
  initTheme();
  // Carregar dados salvos
  loadFromStorage();
  // Iniciar valida√ß√£o autom√°tica
  initAxe();
  // Configurar atalhos
  setupShortcuts();
  // ocultar ferramentas de desenvolvimento em produ√ß√£o
  hideDevToolsIfProd();
    });

  // load reusable a11y tool (if available locally)
  (function(){
    const s = document.createElement('script');
    s.src = 'tools/a11y/a11y-tool.js';
    s.defer = true;
    document.head.appendChild(s);
  })();

    // Hide dev-only UI (remote checker) unless running on localhost or ?dev=1
    function hideDevToolsIfProd() {
      try {
        const isLocalhost = ['127.0.0.1', 'localhost'].includes(location.hostname);
        const urlParams = new URLSearchParams(location.search);
        const allowDev = isLocalhost || urlParams.get('dev') === '1';
        if (!allowDev) {
          const el = document.getElementById('remoteChecker');
          if (el) el.style.display = 'none';
        }
      } catch (e) { /* noop */ }
    }

    // Tool selection UI handlers
    let selectedTool = null;
    function chooseTool(tool) {
      selectedTool = tool;
      // hide selector and show main area
      const sel = document.getElementById('toolSelector'); if (sel) sel.style.display = 'none';
      document.getElementById('mainContent').scrollIntoView({ behavior: 'smooth' });
      // show/hide remoteChecker depending on selection
      const remote = document.getElementById('remoteChecker');
      if (remote) remote.style.display = (tool === 'remote') ? 'block' : 'none';
      // if example chosen, open example page
      if (tool === 'example') {
        window.open('/examples/using-a11y.html','_blank');
      }
      mostrarFeedback('Ferramenta selecionada: ' + tool, 'info');
    }

    function openToolSelector() {
      const sel = document.getElementById('toolSelector'); if (sel) sel.style.display = 'block';
      // hide remoteChecker while choosing again
      const remote = document.getElementById('remoteChecker'); if (remote) remote.style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Gerenciamento de tema
    function initTheme() {
      const theme = localStorage.getItem('theme') || 'auto';
      document.documentElement.dataset.theme = theme;
      updateThemeIcon();
    }

    function toggleTheme() {
      const current = document.documentElement.dataset.theme;
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.documentElement.dataset.theme = newTheme;
      localStorage.setItem('theme', newTheme);
      updateThemeIcon();
    }

    function updateThemeIcon() {
      const isDark = document.documentElement.dataset.theme === 'dark' || 
        (document.documentElement.dataset.theme !== 'light' && 
         window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.getElementById('themeIcon').textContent = isDark ? 'üåö' : 'üåû';
    }

    // Armazenamento local
    function saveToStorage() {
      try {
        localStorage.setItem('telasTestadas', JSON.stringify(telas));
      } catch (error) {
        console.error('Erro ao salvar no localStorage:', error);
        mostrarFeedback('Erro ao salvar os dados localmente', 'erro');
      }
    }

    function loadFromStorage() {
      try {
        const saved = localStorage.getItem('telasTestadas');
        if (saved) {
          telas = JSON.parse(saved);
          renderTelas();
        }
      } catch (error) {
        console.error('Erro ao carregar do localStorage:', error);
        mostrarFeedback('Erro ao carregar dados salvos', 'erro');
      }
    }

    // Valida√ß√£o autom√°tica com axe-core (executa e guarda resultado)
    async function initAxe() {
      if (typeof axe === 'undefined') return;
      
      validacaoAtiva = true;
      try {
        const results = await axe.run();
        lastAxeResults = results;
        const violations = results.violations || [];
        if (violations.length > 0) {
          // Mensagem resumida com instru√ß√£o para ver detalhes no console
          mostrarFeedback(`Encontrados ${violations.length} problemas de acessibilidade (ver console para detalhes)`, 'erro');
          console.group('Axe results');
          console.log(results);
          console.groupEnd();
        } else {
          mostrarFeedback('Valida√ß√£o autom√°tica: nenhum problema encontrado', 'sucesso');
        }
      } catch (err) {
        console.error('Erro na valida√ß√£o:', err);
      }
    }

    // Atalhos de teclado
    function setupShortcuts() {
      document.addEventListener('keydown', (e) => {
        if (e.key === '?') {
          document.getElementById('atalhos').classList.toggle('visible');
        }
        if (e.altKey) {
          switch(e.key.toLowerCase()) {
            case 'a': adicionarTela(); break;
            case 'p': gerarPDF(); break;
            case 'c': exportarCSV(); break;
            case 't': toggleTheme(); break;
            case 'l': document.getElementById('formTela').reset(); break;
          }
        }
      });
    }

    // Renderiza√ß√£o da lista de telas
    function renderTelas() {
      const container = document.getElementById('telasContainer');
      container.innerHTML = '';
      if (telas.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'Nenhuma tela testada ainda.';
        container.appendChild(p);
        return;
      }

      telas.forEach((tela, idx) => {
        const article = document.createElement('article');
        article.className = 'tela-item';

        const header = document.createElement('div');
        header.className = 'tela-header';

        const title = document.createElement('h3');
        title.className = 'tela-titulo';
        title.textContent = `${idx + 1}. ${tela.nomeTela}`;

        const actions = document.createElement('div');
        actions.className = 'tela-acoes';

  const btnEdit = document.createElement('button');
        btnEdit.type = 'button';
        btnEdit.className = 'secondary';
        btnEdit.setAttribute('aria-label', `Editar ${tela.nomeTela}`);
        btnEdit.textContent = '‚úèÔ∏è Editar';
        btnEdit.addEventListener('click', () => editarTela(idx));

        const btnRemove = document.createElement('button');
        btnRemove.type = 'button';
        btnRemove.className = 'secondary';
        btnRemove.setAttribute('aria-label', `Remover ${tela.nomeTela}`);
        btnRemove.textContent = 'üóëÔ∏è Remover';
        btnRemove.addEventListener('click', () => confirmRemover(idx));

  const btnReval = document.createElement('button');
  btnReval.type = 'button';
  btnReval.className = 'secondary';
  btnReval.setAttribute('aria-label', `Revalidar ${tela.nomeTela}`);
  btnReval.textContent = 'üîÅ Revalidar';
  btnReval.addEventListener('click', () => revalidateTela(idx, article));

  actions.appendChild(btnReval);

        actions.appendChild(btnEdit);
        actions.appendChild(btnRemove);

        header.appendChild(title);
        header.appendChild(actions);

        const content = document.createElement('div');
        content.className = 'tela-conteudo';

        const addCampo = (labelText, valueText) => {
          const campo = document.createElement('div');
          campo.className = 'tela-campo';
          const h4 = document.createElement('h4');
          h4.textContent = labelText;
          const p = document.createElement('p');
          p.textContent = valueText;
          campo.appendChild(h4);
          campo.appendChild(p);
          return campo;
        };

        content.appendChild(addCampo('üîä Leitor de Tela', tela.leitor));
        content.appendChild(addCampo('üé® Contraste', tela.contraste));
        content.appendChild(addCampo('üîç Amplia√ß√£o', tela.ampliacao));
        content.appendChild(addCampo('‚å®Ô∏è Navega√ß√£o por Teclado', tela.teclado));
        content.appendChild(addCampo('üåà Uso de Cores', tela.cores));
        content.appendChild(addCampo('üì± Responsividade', tela.responsivo));

        article.appendChild(header);
        article.appendChild(content);
        container.appendChild(article);
      });
    }

    // Feedback visual
    function mostrarFeedback(mensagem, tipo = 'sucesso') {
      const feedbackEl = document.getElementById('feedbackMessage');
      feedbackEl.textContent = mensagem;
      // Garantir classes seguras
      feedbackEl.className = '';
      feedbackEl.classList.add(tipo);
      feedbackEl.style.display = 'block';

      setTimeout(() => {
        feedbackEl.style.display = 'none';
      }, 3000);
    }

    function adicionarTela() {
      const nomeTela = document.getElementById('nomeTela').value.trim();
      if (!nomeTela) {
        mostrarFeedback('Por favor, informe o nome da tela.', 'erro');
        document.getElementById('nomeTela').focus();
        return;
      }

      const leitor = document.getElementById('leitorResultado').value + ' - ' + document.getElementById('leitorObs').value.trim();
      const contraste = document.getElementById('contrasteResultado').value + ' - ' + document.getElementById('contrasteObs').value.trim();
      const ampliacao = document.getElementById('ampliacaoResultado').value + ' - ' + document.getElementById('ampliacaoObs').value.trim();
      const teclado = document.getElementById('tecladoResultado').value + ' - ' + document.getElementById('tecladoObs').value.trim();
      const cores = document.getElementById('coresResultado').value + ' - ' + document.getElementById('coresObs').value.trim();
      const responsivo = document.getElementById('responsivoResultado').value + ' - ' + document.getElementById('responsivoObs').value.trim();

      const tela = { nomeTela, leitor, contraste, ampliacao, teclado, cores, responsivo };
      telas.push(tela);
      
      // Atualizar a interface
      renderTelas();
      // Salvar no localStorage
      saveToStorage();

      mostrarFeedback('Tela adicionada ao relat√≥rio. Total: ' + telas.length, 'sucesso');
      document.getElementById('formTela').reset();
      document.getElementById('nomeTela').focus();
    }

    function gerarPDF() {
      if (telas.length === 0) {
        mostrarFeedback('Nenhuma tela no relat√≥rio. Adicione pelo menos uma tela.', 'erro');
        return;
      }

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        const margin = 40;
        let y = 40;

        doc.setFontSize(14);
        doc.text('Relat√≥rio de Teste de Acessibilidade', margin, y);
        y += 20;

        doc.setFontSize(10);
        telas.forEach((t, idx) => {
          y += 14;
          doc.text((idx + 1) + '. ' + t.nomeTela, margin, y);
          y += 14;
          doc.text('  - Leitor: ' + t.leitor, margin, y);
          y += 12;
          doc.text('  - Contraste: ' + t.contraste, margin, y);
          y += 12;
          doc.text('  - Amplia√ß√£o: ' + t.ampliacao, margin, y);
          y += 12;
          doc.text('  - Teclado: ' + t.teclado, margin, y);
          y += 12;
          doc.text('  - Cores: ' + t.cores, margin, y);
          y += 12;
          doc.text('  - Responsividade: ' + t.responsivo, margin, y);

          if (y > 720) {
            doc.addPage();
            y = 40;
          }
        });

        doc.save('relatorio_acessibilidade.pdf');
        mostrarFeedback('PDF gerado com sucesso.', 'sucesso');
      } catch (err) {
        console.error(err);
        mostrarFeedback('Erro ao gerar PDF: ' + (err.message || err), 'erro');
      }
    }

    // Ajuda de acessibilidade: focus no conte√∫do quando pular link for usado
    document.querySelector('.skip-link').addEventListener('click', function (e) {
      const main = document.getElementById('mainContent');
      if (main) {
        main.setAttribute('tabindex', '-1');
        main.focus();
        main.removeAttribute('tabindex');
      }
    });

    // Exporta√ß√£o CSV
    function exportarCSV() {
      if (telas.length === 0) {
        mostrarFeedback('Nenhuma tela para exportar. Adicione pelo menos uma tela.', 'erro');
        return;
      }

      const headers = ['Tela', 'Leitor', 'Contraste', 'Amplia√ß√£o', 'Teclado', 'Cores', 'Responsivo'];
      const rows = telas.map(tela => [
        tela.nomeTela,
        tela.leitor,
        tela.contraste,
        tela.ampliacao,
        tela.teclado,
        tela.cores,
        tela.responsivo
      ]);

      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'relatorio_acessibilidade.csv';
      link.click();

      mostrarFeedback('CSV exportado com sucesso!');
    }

    // Edi√ß√£o de telas
    function editarTela(index) {
      const tela = telas[index];
      
      // Preencher campos
      document.getElementById('nomeTela').value = tela.nomeTela;
      
      const [leitorRes, ...leitorObs] = tela.leitor.split(' - ');
      document.getElementById('leitorResultado').value = leitorRes;
      document.getElementById('leitorObs').value = leitorObs.join(' - ');
      
      const [contrasteRes, ...contrasteObs] = tela.contraste.split(' - ');
      document.getElementById('contrasteResultado').value = contrasteRes;
      document.getElementById('contrasteObs').value = contrasteObs.join(' - ');
      
      const [ampRes, ...ampObs] = tela.ampliacao.split(' - ');
      document.getElementById('ampliacaoResultado').value = ampRes;
      document.getElementById('ampliacaoObs').value = ampObs.join(' - ');
      
      const [tecladoRes, ...tecladoObs] = tela.teclado.split(' - ');
      document.getElementById('tecladoResultado').value = tecladoRes;
      document.getElementById('tecladoObs').value = tecladoObs.join(' - ');
      
      const [coresRes, ...coresObs] = tela.cores.split(' - ');
      document.getElementById('coresResultado').value = coresRes;
      document.getElementById('coresObs').value = coresObs.join(' - ');
      
      const [respRes, ...respObs] = tela.responsivo.split(' - ');
      document.getElementById('responsivoResultado').value = respRes;
      document.getElementById('responsivoObs').value = respObs.join(' - ');

      // Remover a tela antiga
      telas.splice(index, 1);
      // Atualizar UI
      renderTelas();
      saveToStorage();
      // Focar no campo de nome
      document.getElementById('nomeTela').focus();
      mostrarFeedback('Editando tela...', 'info');
    }

    // Remo√ß√£o de telas via modal acess√≠vel
    let pendingRemoveIndex = null;
    let lastFocusBeforeModal = null;
    function confirmRemover(index) {
      pendingRemoveIndex = index;
      const overlay = document.getElementById('confirmOverlay');
      const message = document.getElementById('confirmMessage');
      // salvar foco atual para restaurar depois
      lastFocusBeforeModal = document.activeElement;
      message.textContent = `Remover \"${telas[index].nomeTela}\"? Esta a√ß√£o n√£o pode ser desfeita.`;
      overlay.hidden = false;
      // mover foco para o bot√£o confirmar
      const ok = document.getElementById('confirmOk');
      ok.focus();
    }

    document.getElementById('confirmCancel')?.addEventListener('click', () => {
      document.getElementById('confirmOverlay').hidden = true;
      pendingRemoveIndex = null;
      try { lastFocusBeforeModal?.focus(); } catch(e){}
    });

    document.getElementById('confirmOk')?.addEventListener('click', () => {
      if (pendingRemoveIndex !== null) {
        telas.splice(pendingRemoveIndex, 1);
        saveToStorage();
        renderTelas();
        mostrarFeedback('Tela removida com sucesso', 'sucesso');
      }
      document.getElementById('confirmOverlay').hidden = true;
      pendingRemoveIndex = null;
      try { lastFocusBeforeModal?.focus(); } catch(e){}
    });
    // Fechar modal com Escape e clique fora
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const overlay = document.getElementById('confirmOverlay');
        if (overlay && !overlay.hidden) {
          overlay.hidden = true;
          pendingRemoveIndex = null;
        }
      }
    });

    document.getElementById('confirmOverlay')?.addEventListener('click', (e) => {
      const modal = document.getElementById('confirmModal');
      if (e.target === document.getElementById('confirmOverlay')) {
        // clique fora do modal
        document.getElementById('confirmOverlay').hidden = true;
        pendingRemoveIndex = null;
      }
    });

    // =====================
    // Accessibility checks
    // =====================
    async function runFullA11yChecks() {
      const a11yContainer = document.getElementById('a11yContainer');
      a11yContainer.innerHTML = '';
      // Prefer reusable A11yTool when loaded
      if (window.A11yTool) {
        try {
          const results = await window.A11yTool.runFullChecks();
          lastAxeResults = results.axe || lastAxeResults;
          if (results.axe && results.axe.violations) {
            const summary = document.createElement('div'); summary.className = 'info'; summary.textContent = `axe-core: ${results.axe.violations.length} viola√ß√µes encontradas`;
            a11yContainer.appendChild(summary);
            renderAxeDetails(results.axe, a11yContainer);
          }
          const crHeading = document.createElement('h4'); crHeading.textContent = 'Contraste (checagem autom√°tica)'; a11yContainer.appendChild(crHeading);
          const contrastResults = results.contrast || [];
          if (contrastResults.length === 0) { const p = document.createElement('p'); p.className = 'info'; p.textContent = 'Nenhum texto detectado para avalia√ß√£o de contraste.'; a11yContainer.appendChild(p); }
          else {
            const failing = contrastResults.filter(r => !r.passes);
            const summary2 = document.createElement('p'); summary2.textContent = `Analisados ${contrastResults.length} elementos. ${failing.length} com contraste insuficiente.`; a11yContainer.appendChild(summary2);
            if (failing.length > 0) { const ul2 = document.createElement('ul'); failing.slice(0,20).forEach(r=>{ const li=document.createElement('li'); li.textContent = `${r.selector} ‚Äî ratio: ${r.ratio.toFixed(2)} ‚Äî exigido: ${r.required}`; ul2.appendChild(li); }); a11yContainer.appendChild(ul2); }
            const complex = contrastResults.filter(r => r.complexBackground);
            if (complex.length>0) { const warn = document.createElement('p'); warn.className='info'; warn.textContent = `${complex.length} elementos possuem background-image/gradiente. Recomenda-se verifica√ß√£o manual.`; a11yContainer.appendChild(warn); }
          }
        } catch (e) { const p = document.createElement('p'); p.className='erro'; p.textContent = 'Erro ao executar A11yTool: ' + (e.message||e); a11yContainer.appendChild(p); }
        return;
      }
      // fallback to inline behaviour if A11yTool not present
      // previous inline implementation continues here
      if (typeof axe !== 'undefined') {
        try {
          const results = await axe.run();
          lastAxeResults = results;
          try { localStorage.setItem('lastAxeResults', JSON.stringify(results)); } catch(e){}
          const summary = document.createElement('div');
          summary.className = 'info';
          summary.textContent = `axe-core: ${results.violations.length} viola√ß√µes encontradas, ${results.passes.length} passes, ${results.incomplete.length} incompletos.`;
          a11yContainer.appendChild(summary);
          renderAxeDetails(results, a11yContainer);
        } catch (err) {
          const p = document.createElement('p'); p.className = 'erro'; p.textContent = 'Erro ao executar axe: ' + (err.message || err);
          a11yContainer.appendChild(p);
        }
      } else {
        const p = document.createElement('p'); p.className = 'info'; p.textContent = 'axe-core n√£o encontrado (CDN n√£o carregado).';
        a11yContainer.appendChild(p);
      }
      try {
        const contrastResults = findTextElementsAndCheckContrast();
        const crHeading = document.createElement('h4');
        crHeading.textContent = 'Contraste (checagem autom√°tica)';
        a11yContainer.appendChild(crHeading);
        if (contrastResults.length === 0) {
          const p = document.createElement('p'); p.className = 'info'; p.textContent = 'Nenhum texto detectado para avalia√ß√£o de contraste.';
          a11yContainer.appendChild(p);
        } else {
          const failing = contrastResults.filter(r => !r.passes);
          const summary2 = document.createElement('p');
          summary2.textContent = `Analisados ${contrastResults.length} elementos. ${failing.length} com contraste insuficiente.`;
          a11yContainer.appendChild(summary2);
          if (failing.length > 0) {
            const ul2 = document.createElement('ul');
            failing.slice(0, 20).forEach(r => {
              const li = document.createElement('li');
              li.textContent = `${r.selector} ‚Äî ratio: ${r.ratio.toFixed(2)} ‚Äî exigido: ${r.required}`;
              ul2.appendChild(li);
            });
            a11yContainer.appendChild(ul2);
          }
        }
      } catch (err) {
        console.warn('Erro na checagem de contraste:', err);
      }
    }

    // Contrast utilities
    function sRGBtoLin(v) {
      v = v / 255;
      return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
    }

    function luminance(r, g, b) {
      return 0.2126 * sRGBtoLin(r) + 0.7152 * sRGBtoLin(g) + 0.0722 * sRGBtoLin(b);
    }

    function contrastRatio(rgb1, rgb2) {
      const L1 = luminance(rgb1[0], rgb1[1], rgb1[2]);
      const L2 = luminance(rgb2[0], rgb2[1], rgb2[2]);
      const lighter = Math.max(L1, L2);
      const darker = Math.min(L1, L2);
      return (lighter + 0.05) / (darker + 0.05);
    }

    function parseComputedRGB(colorStr) {
      // colorStr expected like "rgb(34, 40, 49)" or "rgba(...)"
      const m = colorStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      if (m) return [parseInt(m[1],10), parseInt(m[2],10), parseInt(m[3],10)];
      // fallback: attempt hex
      const hex = colorStr.replace('#','').trim();
      if (hex.length === 3) {
        return [parseInt(hex[0]+hex[0],16), parseInt(hex[1]+hex[1],16), parseInt(hex[2]+hex[2],16)];
      }
      if (hex.length === 6) {
        return [parseInt(hex.slice(0,2),16), parseInt(hex.slice(2,4),16), parseInt(hex.slice(4,6),16)];
      }
      return null;
    }

    function findTextElementsAndCheckContrast() {
      const nodes = Array.from(document.querySelectorAll('p,span,a,li,button,label,h1,h2,h3,h4,h5,h6,td,th'));
      const results = [];
      for (const el of nodes) {
        try {
          const style = window.getComputedStyle(el);
          if (!style || style.visibility === 'hidden' || style.display === 'none' || parseFloat(style.opacity) === 0) continue;
          const text = el.textContent && el.textContent.trim();
          if (!text) continue;
          // get foreground color
          const fg = parseComputedRGB(style.color);
          if (!fg) continue;
          // find background by walking up until non-transparent or detect background-image
          let bgColor = null;
          let node = el;
          let complexBackground = false;
          while (node && node !== document.documentElement) {
            const styleNode = window.getComputedStyle(node);
            const bg = styleNode.backgroundColor;
            const bgImage = styleNode.backgroundImage;
            if (bgImage && bgImage !== 'none') {
              // background-image present; complex case (image/gradient) ‚Äî mark for manual review
              complexBackground = true;
            }
            if (bg && bg !== 'rgba(0, 0, 0, 0)' && bg !== 'transparent') { bgColor = bg; break; }
            node = node.parentElement;
          }
          if (!bgColor) bgColor = window.getComputedStyle(document.body).backgroundColor || 'rgb(255,255,255)';
          const bg = parseComputedRGB(bgColor) || [255,255,255];
          const ratio = contrastRatio(fg, bg);
          // determine required ratio (WCAG): 4.5 normal text, 3.0 large text
          const fontSize = parseFloat(style.fontSize) || 12;
          const fontWeight = style.fontWeight || '400';
          const isLarge = fontSize >= 18 || (fontSize >= 14 && parseInt(fontWeight,10) >= 700);
          const required = isLarge ? 3.0 : 4.5;
          results.push({ selector: elementSelector(el), ratio, required, passes: ratio >= required, complexBackground });
        } catch (e) {
          // ignore individual element errors
        }
      }
      return results;
    }

    function elementSelector(el) {
      if (!el) return '';
      let sel = el.tagName.toLowerCase();
      if (el.id) sel += `#${el.id}`;
      else if (el.className) sel += '.' + Array.from(el.classList).slice(0,2).join('.');
      return sel;
    }

    function exportLastAxeResults() {
      // Prefer A11yTool export if available
      if (window.A11yTool && typeof window.A11yTool.exportReport === 'function') {
        try {
          const payload = {
            timestamp: new Date().toISOString(),
            telas,
            axe: lastAxeResults || (() => { try { return JSON.parse(localStorage.getItem('lastAxeResults')||'null'); } catch(e){return null;} })(),
            contrast: (() => { try { return findTextElementsAndCheckContrast(); } catch(e){return null;} })()
          };
          window.A11yTool.exportReport(payload, 'a11y-report.json');
          mostrarFeedback('Relat√≥rio de acessibilidade exportado (via A11yTool)', 'sucesso');
          return;
        } catch (e) {
          console.warn('A11yTool export failed, falling back', e);
        }
      }
      const combined = {
        timestamp: new Date().toISOString(),
        telas,
        axe: lastAxeResults || (() => { try { return JSON.parse(localStorage.getItem('lastAxeResults')||'null'); } catch(e){return null;} })(),
        contrast: (() => { try { return findTextElementsAndCheckContrast(); } catch(e){return null;} })()
      };
      if (!combined.axe && !combined.contrast) {
        mostrarFeedback('Nenhum resultado dispon√≠vel para exportar', 'erro');
        return;
      }
      const blob = new Blob([JSON.stringify(combined, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'a11y-report.json';
      a.click();
      URL.revokeObjectURL(url);
      mostrarFeedback('Relat√≥rio de acessibilidade exportado', 'sucesso');
    }

    function renderAxeDetails(results, container) {
      if (!results || !results.violations) return;
      const violations = results.violations;
      if (violations.length === 0) {
        const p = document.createElement('p'); p.className = 'sucesso'; p.textContent = 'Nenhuma viola√ß√£o encontrada pelo axe-core.';
        container.appendChild(p);
        return;
      }
      const list = document.createElement('div');
      list.setAttribute('aria-live','polite');
      violations.forEach(v => {
        const section = document.createElement('section');
        section.style.borderTop = '1px solid var(--border)';
        section.style.padding = '8px 0';
        const title = document.createElement('h4');
        title.textContent = `${v.id} ‚Äî ${v.impact || 'impacto n√£o informado'} ‚Äî ${v.help}`;
        section.appendChild(title);
        const desc = document.createElement('p');
        desc.textContent = v.description || v.help || '';
        section.appendChild(desc);
        const ul = document.createElement('ul');
        v.nodes.slice(0,10).forEach(node => {
          const li = document.createElement('li');
          const sel = node.target && node.target.join(', ');
          li.textContent = sel || (node.html ? node.html.substring(0,120) : 'elemento');
          ul.appendChild(li);
        });
        section.appendChild(ul);
        // link to debug in console
        const dbg = document.createElement('button'); dbg.type = 'button'; dbg.textContent = 'Log details';
        dbg.addEventListener('click', () => console.log(v));
        section.appendChild(dbg);
        list.appendChild(section);
      });
      container.appendChild(list);
    }

    // Revalidate a specific tela (element scope)
    async function revalidateTela(index, articleEl) {
      // locate container for this tela to show results
      try {
        const resultArea = document.createElement('div');
        resultArea.style.marginTop = '8px';
        resultArea.className = 'a11y-tela-results';

        // Prefer A11yTool if available
        if (window.A11yTool) {
          try {
            const results = await window.A11yTool.revalidateElement(articleEl);
            if (results.axe) {
              const summary = document.createElement('p');
              summary.textContent = `axe: ${results.axe.violations.length} viola√ß√µes encontradas.`;
              resultArea.appendChild(summary);
              if (results.axe.violations.length > 0) {
                const ul = document.createElement('ul');
                results.axe.violations.slice(0,10).forEach(v => { const li = document.createElement('li'); li.textContent = `${v.id}: ${v.help}`; ul.appendChild(li); });
                resultArea.appendChild(ul);
              }
            } else {
              const p = document.createElement('p'); p.className = 'info'; p.textContent = 'axe-core n√£o dispon√≠vel'; resultArea.appendChild(p);
            }

            if (results.contrast) {
              const failing = results.contrast.filter(r => !r.passes);
              const cr = document.createElement('p'); cr.textContent = `Contraste: ${results.contrast.length} elementos avaliados, ${failing.length} falharam.`; resultArea.appendChild(cr);
              if (failing.length > 0) { const list = document.createElement('ul'); failing.slice(0,10).forEach(f => { const li = document.createElement('li'); li.textContent = `${f.selector} ‚Äî ${f.ratio.toFixed(2)} (req ${f.required})`; list.appendChild(li); }); resultArea.appendChild(list); }
              const complex = results.contrast.filter(r => r.complexBackground);
              if (complex.length > 0) { const warn = document.createElement('p'); warn.className = 'info'; warn.textContent = `${complex.length} elementos possuem background-image/gradiente. Recomenda-se verifica√ß√£o manual ou captura de screenshot para an√°lise de contraste real.`; resultArea.appendChild(warn); }
            }

            // attach result area to article
            const prev = articleEl.querySelector('.a11y-tela-results'); if (prev) prev.remove();
            articleEl.appendChild(resultArea);
            return;
          } catch (e) {
            const p = document.createElement('p'); p.className = 'erro'; p.textContent = 'Erro A11yTool: ' + (e.message || e); resultArea.appendChild(p);
            const prev = articleEl.querySelector('.a11y-tela-results'); if (prev) prev.remove(); articleEl.appendChild(resultArea);
            return;
          }
        }

        // fallback: run axe + contrast checks locally
        if (typeof axe !== 'undefined') {
          try {
            const results = await axe.run(articleEl);
            const summary = document.createElement('p');
            summary.textContent = `axe: ${results.violations.length} viola√ß√µes encontradas.`;
            resultArea.appendChild(summary);
            if (results.violations.length > 0) {
              const ul = document.createElement('ul');
              results.violations.slice(0,10).forEach(v => { const li = document.createElement('li'); li.textContent = `${v.id}: ${v.help}`; ul.appendChild(li); });
              resultArea.appendChild(ul);
            }
          } catch (e) {
            const p = document.createElement('p'); p.className = 'erro'; p.textContent = 'Erro axe: ' + (e.message || e);
            resultArea.appendChild(p);
          }
        } else {
          const p = document.createElement('p'); p.className = 'info'; p.textContent = 'axe-core n√£o dispon√≠vel'; resultArea.appendChild(p);
        }

        // run contrast checks within this article only
        const elResults = [];
        const nodes = Array.from(articleEl.querySelectorAll('p,span,a,li,button,label,h1,h2,h3,h4,h5,h6,td,th'));
        nodes.forEach(n => {
          try {
            const style = window.getComputedStyle(n);
            if (!style || style.visibility === 'hidden' || style.display === 'none' || parseFloat(style.opacity) === 0) return;
            const fg = parseComputedRGB(style.color);
            if (!fg) return;
            let bgColor = null; let node = n;
            while (node && node !== articleEl && node !== document.documentElement) {
              const bg = window.getComputedStyle(node).backgroundColor;
              const bgImage = window.getComputedStyle(node).backgroundImage;
              if (bgImage && bgImage !== 'none') {
                // mark complex backgrounds for manual review
                // propagate flag later via elResults
              }
              if (bg && bg !== 'rgba(0, 0, 0, 0)' && bg !== 'transparent') { bgColor = bg; break; }
              node = node.parentElement;
            }
            if (!bgColor) bgColor = window.getComputedStyle(articleEl).backgroundColor || window.getComputedStyle(document.body).backgroundColor;
            const bg = parseComputedRGB(bgColor) || [255,255,255];
            const ratio = contrastRatio(fg, bg);
            const fontSize = parseFloat(style.fontSize) || 12;
            const fontWeight = style.fontWeight || '400';
            const isLarge = fontSize >= 18 || (fontSize >= 14 && parseInt(fontWeight,10) >= 700);
            const required = isLarge ? 3.0 : 4.5;
            // detect complex background separately
            let complexBackground = false;
            let walker = n;
            while (walker && walker !== articleEl && walker !== document.documentElement) {
              const bgImage = window.getComputedStyle(walker).backgroundImage;
              if (bgImage && bgImage !== 'none') { complexBackground = true; break; }
              walker = walker.parentElement;
            }
            elResults.push({ selector: elementSelector(n), ratio, required, passes: ratio >= required, complexBackground });
          } catch (e) {}
        });
        const failing = elResults.filter(r => !r.passes);
        const complex = elResults.filter(r => r.complexBackground);
        const cr = document.createElement('p'); cr.textContent = `Contraste: ${elResults.length} elementos avaliados, ${failing.length} falharam.`;
        resultArea.appendChild(cr);
        if (failing.length > 0) {
          const list = document.createElement('ul'); failing.slice(0,10).forEach(f => { const li = document.createElement('li'); li.textContent = `${f.selector} ‚Äî ${f.ratio.toFixed(2)} (req ${f.required})`; list.appendChild(li); }); resultArea.appendChild(list);
        }
        if (complex.length > 0) {
          const warn = document.createElement('p'); warn.className = 'info'; warn.textContent = `${complex.length} elementos possuem background-image/gradiente. Recomenda-se verifica√ß√£o manual ou captura de screenshot para an√°lise de contraste real.`;
          resultArea.appendChild(warn);
        }

        // attach result area to article
        const prev = articleEl.querySelector('.a11y-tela-results'); if (prev) prev.remove();
        articleEl.appendChild(resultArea);
      } catch (err) {
        console.error('Revalidate error', err);
      }
    }

    // Executa checagem remota via remote-check-server
    async function runRemoteCheckFromIndex() {
      const url = document.getElementById('remoteUrl').value.trim();
      const selectors = document.getElementById('remoteSelectors').value.split(',').map(s => s.trim()).filter(Boolean);
      const out = document.getElementById('remoteOut');
      if (!url) { mostrarFeedback('Informe a URL para verifica√ß√£o remota', 'erro'); out.textContent = 'Informe a URL para verifica√ß√£o remota'; return; }
      out.textContent = 'Executando checagem remota...';
      try {
        const resp = await fetch('http://127.0.0.1:3001/api/check', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, selectors })
        });
        if (!resp.ok) {
          const txt = await resp.text();
          out.textContent = `Erro remoto: ${resp.status} ${resp.statusText}\n${txt}`;
          mostrarFeedback('Erro ao executar checagem remota', 'erro');
          return;
        }
        const json = await resp.json();
        out.textContent = JSON.stringify(json, null, 2);
        mostrarFeedback('Checagem remota conclu√≠da', 'sucesso');
      } catch (e) {
        out.textContent = 'Erro ao contactar servidor remoto: ' + (e && e.message ? e.message : String(e));
        mostrarFeedback('Erro ao contactar servidor remoto', 'erro');
      }
    }
  </script>
</body>
</html>